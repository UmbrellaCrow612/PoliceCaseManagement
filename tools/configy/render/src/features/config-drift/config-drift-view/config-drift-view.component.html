<div class="container">
  <!-- Page Header -->
  <header class="page-header">
    <h1>Config Drift Detector</h1>
    <div class="page-header-info card">
      <span>
        Directory to run against: <b>{{ store.getSelectedDirectory() }}</b>
      </span>
      @if (sourceDriftFilePath) {
      <span>
        Source file selected: <b>{{ sourceDriftFilePath }}</b>
      </span>
      }
      <button (click)="selectSourceFile()" mat-raised-button color="primary">
        Select Source File
      </button>
    </div>
  </header>

  <!-- Status Messages -->
  @if (err && !isLoading) {
  <div class="status-message error">Error: {{ err }}</div>
  } @if (isLoading && !err) {
  <div class="status-message loading">Loading source file...</div>
  }

  <!-- Source File Components & Configuration -->
  @if (arrKtpvAndConfig.length > 0) {
  <section class="source-config-section card">
    <h2>Source File Configuration</h2>

    <div class="source-items-list">
      @for (item of arrKtpvAndConfig; track $index) {
      <div class="source-item-card card">
        <div class="item-details">
          <dl>
            <dt>Key:</dt>
            <dd>{{ item.ktpv.key }}</dd>
            <dt>Type:</dt>
            <dd>{{ item.ktpv.type }}</dd>
            <dt>Value:</dt>
            <dd>{{ item.ktpv.value }}</dd>
            <dt>Predicate:</dt>
            <dd>{{ item.ktpv.predicate }}</dd>
          </dl>
        </div>
        <div class="item-config">
          @if (item.ktpv.type == "string" && !item.config.exactMatch) {
          <mat-form-field appearance="outline">
            <mat-label>Contains</mat-label>
            <input matInput [(ngModel)]="item.config.contains" />
            <mat-hint>The value must contain this text.</mat-hint>
          </mat-form-field>
          } @if (item.ktpv.type === "number" && !item.config.exactMatch) {
          <mat-form-field appearance="outline">
            <mat-label>Greater than</mat-label>
            <input
              matInput
              [(ngModel)]="item.config.greaterThan"
              type="number"
            />
            <mat-hint>The value must be greater than this.</mat-hint>
          </mat-form-field>
          } @if (item.ktpv.type === "number" && !item.config.exactMatch) {
          <mat-form-field appearance="outline">
            <mat-label>Less than</mat-label>
            <input matInput [(ngModel)]="item.config.lessThan" type="number" />
            <mat-hint>The value must be less than this.</mat-hint>
          </mat-form-field>
          } @if (item.ktpv.type !== "object") {
          <mat-checkbox [(ngModel)]="item.config.exactMatch"
            >Exact value match</mat-checkbox
          >
          }
        </div>
      </div>
      }
    </div>

    <button
      mat-raised-button
      color="primary"
      (click)="scanConfigDrift()"
      [disabled]="isScaning"
    >
      {{ isScaning ? 'Scanning for drift...' : 'Scan for Drift' }}
    </button>
  </section>
  }

  <!-- Drift Scan Results -->
  @if (driftFiles.length > 0 && !isScaning) {
  <section class="drift-results-section card">
    <h2>Drift Found In {{ driftFiles.length }} File(s)</h2>

    <div class="drift-results-list">
      @for (item of driftFiles; track $index) {
      <div class="drift-result-card card">
        <div class="drift-file-info">
          <dl>
            <dt>File:</dt>
            <dd>{{ item.file.fileName }}</dd>
            <dt>Path:</dt>
            <dd>{{ item.file.filePath }}</dd>
          </dl>
        </div>
        <div class="drift-diff-details">
          <span>Differences Found:</span>
          @for (diff of item.diffKtpvs; track $index) {
          <pre>{{ diff | json }}</pre>
          }
        </div>
      </div>
      }
    </div>
  </section>
  }
</div>